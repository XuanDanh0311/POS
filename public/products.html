<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Management - Restro POS</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { color: #2c3e50; font-size: 24px; }
        .nav-links { display: flex; gap: 15px; }
        .nav-links a { color: #3498db; text-decoration: none; padding: 8px 15px; border-radius: 5px; transition: background 0.3s; }
        .nav-links a:hover { background: #ecf0f1; }
        .products-section { background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden; }
        .section-header { padding: 20px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; }
        .section-header h3 { color: #2c3e50; font-size: 18px; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: 600; transition: background 0.3s; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: #3498db; color: white; }
        .btn-primary:hover { background: #2980b9; }
        .btn-success { background: #27ae60; color: white; }
        .btn-success:hover { background: #229954; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-danger:hover { background: #c0392b; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-warning:hover { background: #e67e22; }
        .filters { padding: 20px; border-bottom: 1px solid #e0e0e0; display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .filter-group { display: flex; flex-direction: column; gap: 5px; }
        .filter-group label { font-weight: 600; color: #2c3e50; font-size: 14px; }
        .filter-group input, .filter-group select { padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; }
        .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; padding: 20px; }
        .product-card { background: white; border: 1px solid #e0e0e0; border-radius: 10px; overflow: hidden; transition: all 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .product-card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .product-image { width: 100%; height: 200px; background: #f8f9fa; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .product-image img { width: 100%; height: 100%; object-fit: cover; }
        .product-info { padding: 15px; }
        .product-info h4 { margin-bottom: 8px; color: #2c3e50; }
        .product-price { color: #e74c3c; font-weight: bold; font-size: 18px; margin-bottom: 8px; }
        .product-meta { display: flex; justify-content: space-between; margin-bottom: 15px; font-size: 14px; color: #7f8c8d; }
        .product-actions { display: flex; gap: 8px; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: white; margin: 5% auto; padding: 20px; border-radius: 10px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: black; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; }
        .form-control:focus { outline: none; border-color: #3498db; }
        .image-preview { max-width: 200px; max-height: 200px; margin-top: 10px; border-radius: 5px; }
        .form-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
        .loading { text-align: center; padding: 40px; color: #7f8c8d; }
        .loading i { font-size: 24px; margin-bottom: 10px; }
        @media (max-width: 768px) { .container { padding: 10px; } .header { flex-direction: column; gap: 15px; text-align: center; } .filters { flex-direction: column; align-items: stretch; } .products-grid { grid-template-columns: 1fr; } .modal-content { width: 95%; margin: 10% auto; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-box"></i> Product Management</h1>
            <div class="nav-links">
                <a href="admin.html"><i class="fas fa-cog"></i> Admin Dashboard</a>
                <a href="orders.html"><i class="fas fa-shopping-cart"></i> Orders</a>
            </div>
        </div>
        <div class="products-section">
            <div class="section-header">
                <h3>Product Management</h3>
                <button class="btn btn-primary" id="addProductBtn">
                    <i class="fas fa-plus"></i> Add Product
                </button>
            </div>
            <div class="filters">
                <div class="filter-group">
                    <label>Search</label>
                    <input type="text" id="productSearch" placeholder="Search products...">
                </div>
                <div class="filter-group">
                    <label>Category</label>
                    <select id="categoryFilter">
                        <option value="all">All Categories</option>
                        <option value="food">Food</option>
                        <option value="drinks">Drinks</option>
                        <option value="snacks">Snacks</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>&nbsp;</label>
                    <button class="btn btn-primary" onclick="searchProducts()">
                        <i class="fas fa-search"></i> Search
                    </button>
                </div>
                <div class="filter-group">
                    <label>&nbsp;</label>
                    <button class="btn btn-secondary" onclick="clearProductFilters()">
                        <i class="fas fa-times"></i> Clear
                    </button>
                </div>
            </div>
            <div class="products-grid" id="productsGrid">
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Loading products...</p>
                </div>
            </div>
        </div>
    </div>
    <!-- Add/Edit Product Modal -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2 id="modalTitle">Add New Product</h2>
            <form id="productForm">
                <div class="form-group">
                    <label for="productName">Product Name</label>
                    <input type="text" id="productName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="productPrice">Price</label>
                    <input type="number" id="productPrice" class="form-control" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="productCategory">Category</label>
                    <select id="productCategory" class="form-control" required>
                        <option value="food">Food</option>
                        <option value="drinks">Drinks</option>
                        <option value="snacks">Snacks</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="productStock">Stock</label>
                    <input type="number" id="productStock" class="form-control" value="0" required>
                </div>
                <div class="form-group">
                    <label for="productImage">Product Image</label>
                    <input type="file" id="productImage" class="form-control" accept="image/*">
                    <img id="imagePreview" class="image-preview" style="display: none;">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i> Save Product
                    </button>
                </div>
            </form>
        </div>
    </div>
    <script>
        let products = [];
        let editingProductId = null;

        // Initialize
        window.onload = function() {
            console.log('Product page loaded');
            try {
                loadProducts();
                setupEventListeners();
            } catch (error) {
                console.error('Error in initialization:', error);
                document.body.innerHTML += `<div style="background: red; color: white; padding: 20px; position: fixed; top: 0; left: 0; right: 0; z-index: 9999;">Error: ${error.message}</div>`;
            }
        };

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('productImage').addEventListener('change', handleImageUpload);
            document.getElementById('productForm').addEventListener('submit', handleFormSubmit);
            document.getElementById('productSearch').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchProducts();
                }
            });

            // Close modal when clicking outside
            window.onclick = function(event) {
                const modal = document.getElementById('productModal');
                if (event.target === modal) {
                    closeModal();
                }
            }
        };

        // Load products
        async function loadProducts() {
            console.log('Loading products...');
            try {
                const response = await fetch('/api/products');
                console.log('Products response:', response);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Products data:', data);
                
                products = data.products || [];
                displayProducts();
            } catch (error) {
                console.error('Error loading products:', error);
                document.getElementById('productsGrid').innerHTML = `
                    <div style="background: #fdf2f2; color: #e74c3c; padding: 15px; border-radius: 5px; margin: 10px 0;">
                        Error loading products: ${error.message}
                    </div>
                `;
            }
        }

        // Display products
        function displayProducts(productsToShow = products) {
            const grid = document.getElementById('productsGrid');
            
            if (productsToShow.length === 0) {
                grid.innerHTML = `
                    <div class="loading">
                        <i class="fas fa-search"></i>
                        <p>No products found</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = productsToShow.map(product => {
                // Kiểm tra image có phải là SVG mẫu không
                let showImage = true;
                let imgSrc = `/api/products/${product.id}/image`;
                if (product.image && product.image.startsWith('data:image/svg+xml')) {
                    // Nếu là SVG mẫu, không hiển thị
                    showImage = false;
                }
                return `
                    <div class="product-card">
                        <div class="product-image">
                            ${showImage ? `<img src="${imgSrc}" alt="${product.name}" onerror="this.style.display='none'">` : ''}
                        </div>
                        <div class="product-info">
                            <h4>${product.name}</h4>
                            <div class="product-price">$${parseFloat(product.price).toFixed(2)}</div>
                            <div class="product-meta">
                                <span>Category: ${product.category}</span>
                                <span>Stock: ${product.stock}</span>
                            </div>
                            <div class="product-actions">
                                <button class="btn btn-warning edit-btn" data-id="${product.id}">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-danger delete-btn" data-id="${product.id}">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Gán sự kiện sau khi render
            grid.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', () => editProduct(btn.dataset.id));
            });
            grid.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', () => deleteProduct(btn.dataset.id));
            });
        }

        // Search products
        function searchProducts() {
            const searchTerm = document.getElementById('productSearch').value.toLowerCase();
            const category = document.getElementById('categoryFilter').value;
            
            let filteredProducts = products;

            if (category !== 'all') {
                filteredProducts = filteredProducts.filter(product => product.category === category);
            }

            if (searchTerm) {
                filteredProducts = filteredProducts.filter(product => 
                    product.name.toLowerCase().includes(searchTerm)
                );
            }

            displayProducts(filteredProducts);
        }

        // Clear product filters
        function clearProductFilters() {
            document.getElementById('productSearch').value = '';
            document.getElementById('categoryFilter').value = 'all';
            displayProducts();
        }

        // Handle image upload
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('imagePreview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        // Handle form submit
        async function handleFormSubmit(event) {
            event.preventDefault();
            
            const productData = {
                name: document.getElementById('productName').value,
                price: parseFloat(document.getElementById('productPrice').value),
                category: document.getElementById('productCategory').value,
                stock: parseInt(document.getElementById('productStock').value)
            };
            
            // Add image if selected
            const imagePreview = document.getElementById('imagePreview');
            if (imagePreview.style.display !== 'none') {
                productData.image = imagePreview.src;
            }

            try {
                const url = editingProductId ? `/api/products/${editingProductId}` : '/api/products';
                const method = editingProductId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(productData)
                });

                if (response.ok) {
                    closeModal();
                    loadProducts();
                    alert(editingProductId ? 'Product updated successfully!' : 'Product added successfully!');
                } else {
                    const error = await response.json();
                    alert('Error: ' + error.error);
                }
            } catch (error) {
                console.error('Error saving product:', error);
                alert('Error saving product');
            }
        }

        // Show add product modal
        function showAddProductModal() {
            editingProductId = null;
            document.getElementById('modalTitle').textContent = 'Add New Product';
            document.getElementById('productForm').reset();
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('productModal').style.display = 'block';
        }

        // Edit product
        async function editProduct(productId) {
            try {
                const response = await fetch(`/api/products/${productId}`);
                const product = await response.json();
                
                editingProductId = productId;
                document.getElementById('modalTitle').textContent = 'Edit Product';
                document.getElementById('productName').value = product.name;
                document.getElementById('productPrice').value = product.price;
                document.getElementById('productCategory').value = product.category;
                document.getElementById('productStock').value = product.stock;
                
                if (product.image) {
                    document.getElementById('imagePreview').src = `/api/products/${productId}/image`;
                    document.getElementById('imagePreview').style.display = 'block';
                }
                
                document.getElementById('productModal').style.display = 'block';
            } catch (error) {
                console.error('Error loading product:', error);
                alert('Error loading product details');
            }
        }

        // Delete product
        async function deleteProduct(productId) {
            if (!confirm('Are you sure you want to delete this product?')) {
                return;
            }

            try {
                const response = await fetch(`/api/products/${productId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    loadProducts();
                    alert('Product deleted successfully!');
                } else {
                    const error = await response.json();
                    alert('Error: ' + error.error);
                }
            } catch (error) {
                console.error('Error deleting product:', error);
                alert('Error deleting product');
            }
        }

        // Close modal
        function closeModal() {
            document.getElementById('productModal').style.display = 'none';
            editingProductId = null;
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('addProductBtn').addEventListener('click', function() {
                window.location.href = 'add_product.html';
            });
        });
    </script>
</body>
</html> 